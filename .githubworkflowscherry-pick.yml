name: ğŸ’ Cherry-pick Manuel

on:
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Hash du commit Ã  cherry-pick (ex: abc1234)'
        required: true
        type: string
      
      target_repos:
        description: 'DÃ©pÃ´ts cibles'
        required: true
        type: choice
        options:
          - 'Tous les dÃ©pÃ´ts'
          - 'cabinetzemzem'
          - 'cabinettayba'
          - 'cabinetmedipole'
          - 'cabinetorient'
          - 'SÃ©lection personnalisÃ©e'
      
      custom_repos:
        description: 'Si "SÃ©lection personnalisÃ©e": repos sÃ©parÃ©s par des virgules (ex: cabinetzemzem,cabinettayba)'
        required: false
        type: string
      
      conflict_strategy:
        description: 'StratÃ©gie en cas de conflit'
        required: true
        type: choice
        default: 'abort'
        options:
          - 'abort' # ArrÃªter en cas de conflit
          - 'theirs' # Prendre la version du commit source
          - 'ours' # Garder la version du dÃ©pÃ´t cible
      
      force_push:
        description: 'Forcer le push en cas de problÃ¨me'
        required: false
        type: boolean
        default: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      target_list: ${{ steps.repos.outputs.target_list }}
    steps:
    - name: DÃ©terminer les dÃ©pÃ´ts cibles
      id: repos
      run: |
        case "${{ github.event.inputs.target_repos }}" in
          "Tous les dÃ©pÃ´ts")
            echo 'target_list=["cabinetzemzem","cabinettayba","cabinetmedipole","cabinetorient"]' >> $GITHUB_OUTPUT
            ;;
          "SÃ©lection personnalisÃ©e")
            # Convertir la liste en format JSON
            repos="${{ github.event.inputs.custom_repos }}"
            json_array=$(echo "$repos" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "target_list=$json_array" >> $GITHUB_OUTPUT
            ;;
          *)
            echo 'target_list=["${{ github.event.inputs.target_repos }}"]' >> $GITHUB_OUTPUT
            ;;
        esac

  cherry-pick:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.prepare.outputs.target_list) }}
      fail-fast: false
    
    steps:
    - name: ğŸ“‹ Informations de la tÃ¢che
      run: |
        echo "ğŸ’ Cherry-pick du commit: ${{ github.event.inputs.commit_hash }}"
        echo "ğŸ¯ Vers le dÃ©pÃ´t: ${{ matrix.repo }}"
        echo "âš™ï¸ StratÃ©gie de conflit: ${{ github.event.inputs.conflict_strategy }}"
        echo "ğŸ’ª Force push: ${{ github.event.inputs.force_push }}"

    - name: âš™ï¸ Configuration Git
      run: |
        git config --global user.name "Cherry-pick Bot"
        git config --global user.email "cherry-pick@actions.github.com"

    - name: ğŸ“¥ Clone du dÃ©pÃ´t source (dentalhouse)
      uses: actions/checkout@v4
      with:
        repository: ahmedoukhlil/dentalhouse
        token: ${{ secrets.SYNC_TOKEN }}
        fetch-depth: 0
        path: source-repo

    - name: ğŸ“¥ Clone du dÃ©pÃ´t cible (${{ matrix.repo }})
      run: |
        git clone https://${{ secrets.SYNC_TOKEN }}@github.com/ahmedoukhlil/${{ matrix.repo }}.git target-repo
        cd target-repo
        git config user.name "Cherry-pick Bot"
        git config user.email "cherry-pick@actions.github.com"

    - name: ğŸ”— Ajout du remote source
      run: |
        cd target-repo
        git remote add source ../source-repo
        git fetch source

    - name: ğŸ’ ExÃ©cution du cherry-pick
      id: cherry_pick
      run: |
        cd target-repo
        
        echo "ğŸ” VÃ©rification du commit..."
        if ! git cat-file -e ${{ github.event.inputs.commit_hash }}^{commit} 2>/dev/null; then
          echo "âŒ Commit ${{ github.event.inputs.commit_hash }} introuvable"
          exit 1
        fi
        
        echo "ğŸ“ Informations du commit:"
        git show --no-patch --format="Auteur: %an <%ae>%nDate: %ad%nMessage: %s" ${{ github.event.inputs.commit_hash }}
        
        echo "ğŸ’ Tentative de cherry-pick..."
        if git cherry-pick ${{ github.event.inputs.commit_hash }}; then
          echo "âœ… Cherry-pick rÃ©ussi!"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Conflit dÃ©tectÃ©!"
          echo "ğŸ“‹ Fichiers en conflit:"
          git status --porcelain
          
          case "${{ github.event.inputs.conflict_strategy }}" in
            "abort")
              echo "ğŸ›‘ Abandon du cherry-pick (stratÃ©gie: abort)"
              git cherry-pick --abort
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
            "theirs")
              echo "ğŸ”§ RÃ©solution automatique (stratÃ©gie: theirs)"
              git status --porcelain | grep "^UU" | cut -c4- | while read file; do
                echo "   RÃ©solution: $file (version source)"
                git checkout --theirs "$file"
                git add "$file"
              done
              git cherry-pick --continue
              echo "success=true" >> $GITHUB_OUTPUT
              ;;
            "ours")
              echo "ğŸ”§ RÃ©solution automatique (stratÃ©gie: ours)"
              git status --porcelain | grep "^UU" | cut -c4- | while read file; do
                echo "   RÃ©solution: $file (version cible)"
                git checkout --ours "$file"
                git add "$file"
              done
              git cherry-pick --continue
              echo "success=true" >> $GITHUB_OUTPUT
              ;;
          esac
        fi

    - name: ğŸ“¤ Push vers le dÃ©pÃ´t cible
      if: steps.cherry_pick.outputs.success == 'true'
      run: |
        cd target-repo
        
        echo "ğŸ“¤ Push vers ${{ matrix.repo }}..."
        if [ "${{ github.event.inputs.force_push }}" = "true" ]; then
          echo "ğŸ’ª Force push activÃ©"
          git push origin main --force
        else
          git push origin main
        fi
        
        echo "âœ… Push rÃ©ussi vers ${{ matrix.repo }}!"

    - name: ğŸ“Š RÃ©sumÃ© pour ${{ matrix.repo }}
      if: always()
      run: |
        cd target-repo 2>/dev/null || echo "DÃ©pÃ´t cible non disponible"
        
        echo "ğŸ“Š === RÃ‰SUMÃ‰ POUR ${{ matrix.repo }} ==="
        echo "ğŸ’ Commit: ${{ github.event.inputs.commit_hash }}"
        echo "âœ… Statut: ${{ steps.cherry_pick.outputs.success == 'true' && 'RÃ‰USSI' || 'Ã‰CHEC' }}"
        
        if [ "${{ steps.cherry_pick.outputs.success }}" = "true" ]; then
          echo "ğŸ‰ Cherry-pick appliquÃ© avec succÃ¨s!"
          echo "ğŸ“ Dernier commit:"
          git log -1 --oneline 2>/dev/null || echo "Log non disponible"
        else
          echo "âŒ Cherry-pick Ã©chouÃ© ou abandonnÃ©"
        fi

  summary:
    needs: [prepare, cherry-pick]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ“Š RÃ©sumÃ© global
      run: |
        echo "ğŸ¯ === RÃ‰SUMÃ‰ GLOBAL DU CHERRY-PICK ==="
        echo "ğŸ’ Commit cherry-picked: ${{ github.event.inputs.commit_hash }}"
        echo "ğŸ“¦ DÃ©pÃ´ts ciblÃ©s: ${{ github.event.inputs.target_repos }}"
        echo "âš™ï¸ StratÃ©gie de conflit: ${{ github.event.inputs.conflict_strategy }}"
        echo "ğŸ’ª Force push: ${{ github.event.inputs.force_push || 'false' }}"
        echo ""
        echo "âœ… OpÃ©ration terminÃ©e!"
        echo "ğŸ” VÃ©rifiez les logs individuels ci-dessus pour les dÃ©tails."